# Стратегия обновлений приложения

## Обзор

Система обновлений приложения поддерживает три типа обновлений:

1. **Принудительные обновления** - автоматически применяются без согласия пользователя
2. **Предложения обновлений бандла** - пользователь может выбрать, обновляться или нет
3. **Предложения обновлений из магазина** - пользователь перенаправляется в магазин приложений

## Типы обновлений

### 1. Принудительные обновления (Force Update)

**Когда применяется:**
- Критические баги безопасности
- Несовместимость версий (разница в 2+ версии)
- Критический флаг в базе данных
- Проблемы с API совместимостью

**Поведение:**
- Автоматическое применение без согласия пользователя
- Показ уведомления о критическом обновлении
- Принудительный перезапуск приложения

### 2. Предложения обновлений бандла

**Когда применяется:**
- Новые функции
- Исправления багов
- Улучшения UX
- Нет критических обновлений

**Поведение:**
- Показ модального окна с предложением
- Пользователь может принять или отклонить
- Обновление применяется при следующем запуске (если не force update)

### 3. Предложения обновлений из магазина

**Когда применяется:**
- Новая версия приложения в магазине
- Нет критических обновлений бандла

**Поведение:**
- Показ уведомления с ссылкой на магазин
- Пользователь перенаправляется в магазин приложений

## Конфигурация

### Переменные окружения

```env
HOT_UPDATER_SUPABASE_URL=https://your-project.supabase.co
HOT_UPDATER_SUPABASE_ANON_KEY=your-anon-key
HOT_UPDATER_SUPABASE_BUCKET_NAME=hotupdate
```

### Настройка в коде

```typescript
// В UpdateProvider
<UpdateProvider
  autoCheck={true}
  checkInterval={6 * 60 * 60 * 1000} // 6 часов
  onUpdateAvailable={(strategy) => {
    console.log('Update available:', strategy);
  }}
>
  {/* Ваше приложение */}
</UpdateProvider>
```

## Использование

### Автоматическая проверка

Система автоматически проверяет обновления при запуске приложения и с заданным интервалом.

### Ручная проверка

```typescript
import { useUpdateManager } from './hooks/useUpdateManager';

const { checkForUpdates } = useUpdateManager();

const handleManualCheck = async () => {
  const strategy = await checkForUpdates();
  console.log('Update strategy:', strategy);
};
```

### Показ модального окна

```typescript
import { UpdateModal } from './widgets/modals/UpdateModal';

const [showModal, setShowModal] = useState(false);

<UpdateModal
  visible={showModal}
  onClose={() => setShowModal(false)}
/>
```

## Развертывание обновлений

### 1. Создание бандла

```bash
# Создание бандла для iOS
npm run deploy:ios

# Создание бандла для Android
npm run deploy:android
```

### 2. Настройка Supabase

1. Создайте Edge Function `update-server` в Supabase
2. Настройте базу данных для хранения метаданных бандлов
3. Настройте Storage bucket для хранения бандлов

### 3. Управление версиями

- Используйте семантическое версионирование (semver)
- Указывайте минимальную и максимальную совместимые версии приложения
- Устанавливайте флаг `isCritical` для критических обновлений

## Безопасность

### Проверки совместимости

- Проверка версии приложения
- Проверка совместимости API
- Проверка минимальной версии бандла

### Защита от откатов

- Использование UUIDv7 для уникальной идентификации бандлов
- Проверка активации бандла в базе данных
- Принудительный откат к активному бандлу при необходимости

## Мониторинг

### Логирование

```typescript
// В onUpdateAvailable callback
onUpdateAvailable={(strategy) => {
  console.log('Update strategy:', strategy);
  // Отправка аналитики
  analytics.track('update_available', {
    type: strategy.type,
    reason: strategy.reason,
  });
}}
```

### Метрики

- Количество успешных обновлений
- Количество откатов
- Время скачивания бандлов
- Процент пользователей с актуальной версией

## Troubleshooting

### Проблемы с обновлениями

1. **Обновления не скачиваются**
   - Проверьте настройки Supabase
   - Проверьте переменные окружения
   - Проверьте права доступа к Storage

2. **Принудительные обновления не работают**
   - Проверьте флаг `shouldForceUpdate`
   - Проверьте совместимость версий
   - Проверьте настройки в базе данных

3. **Модальные окна не показываются**
   - Проверьте интеграцию UpdateProvider
   - Проверьте состояние currentStrategy
   - Проверьте логи консоли

### Отладка

```typescript
// Включение подробного логирования
import { updateService } from './service/updateService';

// Получение текущей конфигурации
const config = updateService.getConfig();
console.log('Update config:', config);

// Обновление конфигурации
updateService.updateConfig({
  forceUpdateThreshold: 1,
  enableBundleUpdates: true,
});
``` 